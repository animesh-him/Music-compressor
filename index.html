<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MP3 Compressor</title>

<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>
<script src="https://unpkg.com/@ffmpeg/util@0.12.6/dist/util.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
body{
  margin:0;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background:linear-gradient(135deg,#00c6ff,#00f2c3);
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
}
.container{
  width:100%;
  max-width:420px;
  padding:16px;
  text-align:center;
  color:#fff;
}
.card{
  background:#ffffff22;
  border-radius:16px;
  padding:16px;
}
button,select{
  width:100%;
  margin-top:10px;
  padding:14px;
  border:none;
  border-radius:12px;
  font-size:15px;
}
button{
  background:#000;
  color:#fff;
}
button:disabled{opacity:.5}
select{color:#000}
.progressWrap{display:none;margin-top:12px}
.progress{height:10px;background:#ffffff55;border-radius:8px;overflow:hidden}
.bar{height:100%;width:0;background:#00ffcc}
.stats{display:none;font-size:13px;margin-top:10px}
footer{margin-top:16px;font-size:12px;opacity:.8}
</style>
</head>

<body>
<div class="container">
  <h2>MP3 Compressor</h2>

  <div class="card">

    <input id="singleInput" type="file" accept="audio/mp3" hidden>
    <input id="multiInput" type="file" accept="audio/mp3" multiple hidden>

    <button onclick="singleInput.click()">Upload Single MP3</button>
    <button onclick="multiInput.click()">Upload Multiple MP3s</button>

    <select id="bitrate">
      <option value="120" selected>120 kbps (Recommended)</option>
      <option value="96">96 kbps</option>
      <option value="64">64 kbps</option>
    </select>

    <div class="progressWrap" id="progressWrap">
      <div class="progress"><div class="bar" id="bar"></div></div>
      <div id="progressText" style="font-size:12px;margin-top:6px"></div>
    </div>

    <div class="stats" id="stats"></div>

    <button id="downloadOne" style="display:none" onclick="downloadSingle()">Download File</button>
    <button id="downloadAll" style="display:none" onclick="downloadAll()">Download All Individually</button>
    <button id="downloadZip" style="display:none" onclick="downloadZip()">Download ZIP</button>

  </div>

  <footer>Created by Animesh</footer>
</div>

<script>
const { FFmpeg } = FFmpegWASM;
const { fetchFile } = FFmpegUtil;
const ffmpeg = new FFmpeg();

let outputs=[];

singleInput.onchange=e=>processFiles([...e.target.files]);
multiInput.onchange=e=>processFiles([...e.target.files]);

async function processFiles(files){
  outputs=[];
  hideDownloads();
  stats.style.display='none';

  if(!files.length) return;

  progressWrap.style.display='block';
  bar.style.width='0%';
  progressText.innerText='Loading engine…';

  if(!ffmpeg.loaded){
    await ffmpeg.load({
      coreURL:'https://unpkg.com/@ffmpeg/core@0.12.6/dist/ffmpeg-core.js'
    });
  }

  const br=bitrate.value+'k';
  let done=0;

  for(const file of files){
    const inName=file.name;
    const outName='ANI_'+inName.replace(/\.[^/.]+$/,'.mp3');

    await ffmpeg.writeFile(inName, await fetchFile(file));
    await ffmpeg.exec(['-i',inName,'-b:a',br,outName]);
    const data=await ffmpeg.readFile(outName);

    outputs.push({
      name:outName,
      blob:new Blob([data.buffer],{type:'audio/mpeg'}),
      before:file.size,
      after:data.buffer.byteLength
    });

    done++;
    const pct=Math.round(done/files.length*100);
    bar.style.width=pct+'%';
    progressText.innerText=`Processing ${pct}%`;
  }

  showStats();
  showDownloads(files.length);
}

function showStats(){
  let html='';
  outputs.forEach(o=>{
    html+=`${o.name}<br>
    ${(o.before/1024/1024).toFixed(2)} MB → ${(o.after/1024/1024).toFixed(2)} MB<br><br>`;
  });
  stats.innerHTML=html;
  stats.style.display='block';
}

function hideDownloads(){
  downloadOne.style.display='none';
  downloadAll.style.display='none';
  downloadZip.style.display='none';
}

function showDownloads(count){
  if(count===1) downloadOne.style.display='block';
  if(count>1){
    downloadAll.style.display='block';
    downloadZip.style.display='block';
  }
}

function downloadSingle(){save(outputs[0])}
function downloadAll(){outputs.forEach(save)}
function save(o){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(o.blob);
  a.download=o.name;
  a.click();
}

async function downloadZip(){
  const zip=new JSZip();
  outputs.forEach(o=>zip.file(o.name,o.blob));
  const blob=await zip.generateAsync({type:'blob'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='ANI_audio.zip';
  a.click();
}
</script>
</body>
</html>
