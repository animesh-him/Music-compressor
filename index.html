<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>MP3 Compressor</title>

<style>
* { box-sizing: border-box; font-family: system-ui, sans-serif; }

body {
  margin: 0;
  min-height: 100vh;
  background: linear-gradient(135deg,#ff00cc,#3333ff,#00ffcc,#ff6600);
  background-size: 400% 400%;
  animation: bg 12s ease infinite;
  display: flex;
  justify-content: center;
  align-items: center;
  color: #fff;
}

body.dark {
  background: linear-gradient(135deg,#000,#111,#222,#000);
}

@keyframes bg {
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}

.container {
  width: 100%;
  max-width: 420px;
  padding: 14px;
  text-align: center;
}

h1 { font-size: 1.2rem; }

label.drop-box {
  width: 96px;
  height: 96px;
  margin: 12px auto;
  border-radius: 16px;
  background: rgba(0,0,0,0.35);
  border: 2px dashed #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 0.65rem;
  line-height: 1.2;
  cursor: pointer;
}

select, button {
  width: 100%;
  margin-top: 8px;
  padding: 10px;
  border-radius: 12px;
  border: none;
}

button { background:#000; color:#fff; }

.progress {
  width: 100%;
  height: 8px;
  background: rgba(255,255,255,0.25);
  border-radius: 10px;
  overflow: hidden;
  margin-top: 10px;
}

.bar {
  height: 100%;
  width: 0%;
  background: #00ffcc;
}

.stats {
  margin-top: 8px;
  font-size: 0.75rem;
  text-align: left;
  max-height: 140px;
  overflow-y: auto;
}

audio { width: 100%; margin-top: 8px; }

.footer {
  margin-top: 12px;
  font-size: 0.7rem;
  opacity: 0.8;
}
</style>
</head>

<body>
<div class="container">

<h1>MP3 Compressor</h1>

<!-- ✅ RELIABLE MOBILE INPUT -->
<label for="fileInput" class="drop-box">
Tap or Drop<br>MP3(s)
</label>

<input id="fileInput" type="file" accept="audio/mp3" multiple hidden>

<select id="bitrate">
  <option value="120" selected>120 kbps (Recommended)</option>
  <option value="96">96 kbps</option>
  <option value="80">80 kbps</option>
  <option value="64">64 kbps</option>
</select>

<button id="darkToggle">Toggle Dark Neon</button>
<button id="opusToggle">Enable OPUS (Advanced)</button>

<div class="progress"><div class="bar" id="bar"></div></div>
<div class="stats" id="stats"></div>
<audio id="preview" controls hidden></audio>

<div class="footer">Created by Animesh</div>

</div>

<script type="module">
import { createFFmpeg, fetchFile } from "https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js";

const ffmpeg = createFFmpeg({ log:false });
let useOpus = false;

const input = document.getElementById("fileInput");
const bar = document.getElementById("bar");
const stats = document.getElementById("stats");
const preview = document.getElementById("preview");

document.getElementById("darkToggle").onclick =
  () => document.body.classList.toggle("dark");

document.getElementById("opusToggle").onclick =
  () => useOpus = !useOpus;

function kb(b){ return (b/1024).toFixed(1)+" KB"; }

input.onchange = async e => {
  const files = [...e.target.files];
  if (!files.length) return;

  stats.innerHTML = "Loading engine...";
  if (!ffmpeg.isLoaded()) await ffmpeg.load();

  const start = Date.now();
  let total = files.length;

  for (let i=0;i<files.length;i++) {
    const f = files[i];
    ffmpeg.FS("writeFile", f.name, await fetchFile(f));

    const out = "c_"+f.name;
    const codec = useOpus ? ["-c:a","libopus","-b:a","64k"] :
      ["-c:a","libmp3lame","-b:a",document.getElementById("bitrate").value+"k"];

    await ffmpeg.run("-i",f.name,"-vn",...codec,out);

    const data = ffmpeg.FS("readFile", out);
    const blob = new Blob([data.buffer], { type:"audio/mp3" });

    const done = i+1;
    const elapsed = (Date.now()-start)/1000;
    const eta = ((elapsed/done)*(total-done)).toFixed(1);

    bar.style.width = Math.round((done/total)*100)+"%";
    stats.innerHTML = `
      ${f.name}<br>
      ${kb(f.size)} → ${kb(blob.size)}<br>
      ${Math.round((done/total)*100)}% · ETA ${eta}s
    `;

    if (total === 1) {
      preview.src = URL.createObjectURL(blob);
      preview.hidden = false;
    }
  }
};
</script>
</body>
</html>
