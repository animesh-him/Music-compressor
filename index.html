<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>MP3 Compressor</title>

<style>
* { box-sizing: border-box; font-family: system-ui, sans-serif; }

body {
  margin: 0;
  min-height: 100vh;
  background: linear-gradient(135deg,#ff00cc,#3333ff,#00ffcc,#ff6600);
  background-size: 400% 400%;
  animation: bg 12s ease infinite;
  display: flex;
  justify-content: center;
  align-items: center;
  color: #fff;
}

@keyframes bg {
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}

.container {
  width: 100%;
  max-width: 420px;
  padding: 14px;
  text-align: center;
}

h1 { font-size: 1.2rem; margin-bottom: 10px; }

.drop-box {
  width: 96px;
  height: 96px;
  margin: 12px auto;
  border-radius: 16px;
  background: rgba(0,0,0,0.35);
  border: 2px dashed #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 0.65rem;
  cursor: pointer;
  user-select: none;
  line-height: 1.2;
}

select, button {
  width: 100%;
  margin-top: 8px;
  padding: 10px;
  border-radius: 12px;
  border: none;
  font-size: 0.9rem;
}

select { background: rgba(255,255,255,0.9); }

button {
  background: #000;
  color: #fff;
}

button:disabled { opacity: 0.5; }

.progress {
  width: 100%;
  height: 8px;
  background: rgba(255,255,255,0.25);
  border-radius: 10px;
  overflow: hidden;
  margin-top: 10px;
}

.bar {
  height: 100%;
  width: 0%;
  background: #00ffcc;
}

.stats {
  margin-top: 10px;
  font-size: 0.75rem;
  text-align: left;
  max-height: 140px;
  overflow-y: auto;
}

.footer {
  margin-top: 14px;
  font-size: 0.7rem;
  opacity: 0.85;
}
</style>
</head>

<body>
<div class="container">

<h1>MP3 Compressor</h1>

<div class="drop-box" id="dropBox">
Tap or Drop<br>MP3(s)
</div>

<input
  type="file"
  id="fileInput"
  accept="audio/mp3"
  multiple
  hidden
/>

<select id="bitrate">
  <option value="120" selected>120 kbps (Recommended)</option>
  <option value="96">96 kbps</option>
  <option value="80">80 kbps</option>
  <option value="64">64 kbps</option>
</select>

<button id="downloadAllBtn" disabled>Download All Individually</button>
<button id="downloadZipBtn" disabled>Download ZIP</button>

<div class="progress"><div class="bar" id="bar"></div></div>
<div class="stats" id="stats"></div>

<div class="footer">Created by Animesh</div>

</div>

<script type="module">
import { createFFmpeg, fetchFile } from "https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js";
import JSZip from "https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm";

const ffmpeg = createFFmpeg({ log: false });
const fileInput = document.getElementById("fileInput");
const dropBox = document.getElementById("dropBox");
const bar = document.getElementById("bar");
const stats = document.getElementById("stats");
const bitrate = document.getElementById("bitrate");

let compressedFiles = [];
let ffmpegLoaded = false;

function formatSize(b){ return (b/1024).toFixed(1)+" KB"; }

async function loadFFmpeg() {
  if (!ffmpegLoaded) {
    await ffmpeg.load();
    ffmpegLoaded = true;
  }
}

async function compressFiles(files) {
  await loadFFmpeg();
  compressedFiles = [];
  stats.innerHTML = "";
  bar.style.width = "0%";

  let totalO = 0, totalC = 0;

  for (let i = 0; i < files.length; i++) {
    const f = files[i];
    totalO += f.size;

    ffmpeg.FS("writeFile", f.name, await fetchFile(f));
    const out = "c_" + f.name;

    await ffmpeg.run(
      "-i", f.name,
      "-vn",
      "-c:a", "libmp3lame",
      "-b:a", bitrate.value + "k",
      out
    );

    const data = ffmpeg.FS("readFile", out);
    const blob = new Blob([data.buffer], { type: "audio/mp3" });
    totalC += blob.size;

    const red = (((f.size - blob.size) / f.size) * 100).toFixed(1);
    stats.innerHTML += `
      <div>
        ${f.name}<br>
        ${formatSize(f.size)} → ${formatSize(blob.size)} (${red}% ↓)
      </div><br>
    `;

    compressedFiles.push({ name: out, blob });
    bar.style.width = Math.round(((i+1)/files.length)*100)+"%";
  }

  if (files.length > 1) {
    const tr = (((totalO - totalC)/totalO)*100).toFixed(1);
    stats.innerHTML =
      `<b>Total:</b> ${formatSize(totalO)} → ${formatSize(totalC)} (${tr}% ↓)<br><br>` +
      stats.innerHTML;
  }

  downloadAllBtn.disabled = false;
  downloadZipBtn.disabled = false;
}

function download(blob, name) {
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
}

fileInput.onchange = e => {
  if (e.target.files.length) compressFiles(e.target.files);
};

dropBox.onclick = () => {
  fileInput.value = ""; // IMPORTANT: prevents double-trigger
  fileInput.click();
};

dropBox.ondragover = e => e.preventDefault();

dropBox.ondrop = e => {
  e.preventDefault();
  compressFiles(e.dataTransfer.files);
};

downloadAllBtn.onclick = () =>
  compressedFiles.forEach(f => download(f.blob, f.name));

downloadZipBtn.onclick = async () => {
  const zip = new JSZip();
  compressedFiles.forEach(f => zip.file(f.name, f.blob));
  download(await zip.generateAsync({ type: "blob" }), "compressed_mp3s.zip");
};
</script>
</body>
</html>
